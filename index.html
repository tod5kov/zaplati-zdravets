<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –í–µ–¥–æ–º–æ—Å—Ç –∏ —Ñ–∏—à–æ–≤–µ</title>

<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
h2,h3 { margin:8px 0; }

.toolbar {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:15px;
}

button, select, input {
  padding:6px 10px;
  border:1px solid #333;
  background:#fff;
  border-radius:6px;
}

table {
  border-collapse: collapse;
  width:100%;
  background:#fff;
}

th,td {
  border:1px solid #000;
  padding:5px;
  font-size:12px;
  text-align:center;
}

th { background:#e8eef5; }
input[type="number"] { width:80px; }
input.name { width:140px; }

tr.dragging { opacity:0.4; }

.fish {
  border:1px solid #000;
  padding:10px;
  margin:10px 0;
  page-break-inside:avoid;
}

.cut { border-top:2px dashed #000; margin:12px 0; }

/* ===== MODALS ===== */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  align-items:center;
  justify-content:center;
}

.modal-content {
  background:#fff;
  padding:15px;
  width:420px;
  border-radius:8px;
}

.modal label { display:block; margin:6px 0; }

@media print {
  .toolbar, .modal { display:none !important; }
  body { background:#fff; padding:0; }
}
</style>
</head>

<body>

<h2>–ó–∞–ø–ª–∞—Ç–∏</h2>

<div class="toolbar">
  <label>–û–±–µ–∫—Ç:
    <select id="objectSelect"></select>
  </label>
  <button id="btnAddObject">‚ûï –û–±–µ–∫—Ç</button>

  <label>–ú–µ—Å–µ—Ü:
    <select id="month">
      <option>–Ø–Ω—É–∞—Ä–∏</option><option>–§–µ–≤—Ä—É–∞—Ä–∏</option><option>–ú–∞—Ä—Ç</option>
      <option>–ê–ø—Ä–∏–ª</option><option>–ú–∞–π</option><option>–Æ–Ω–∏</option>
      <option>–Æ–ª–∏</option><option>–ê–≤–≥—É—Å—Ç</option><option>–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
      <option>–û–∫—Ç–æ–º–≤—Ä–∏</option><option>–ù–æ–µ–º–≤—Ä–∏</option><option>–î–µ–∫–µ–º–≤—Ä–∏</option>
    </select>
  </label>

  <label>–ì–æ–¥–∏–Ω–∞:
    <input type="number" id="year" value="2025" style="width:80px;">
  </label>

  <button id="btnAddRow">‚ûï –°–ª—É–∂–∏—Ç–µ–ª</button>
  <button id="btnLoadTemplate">üß© –ó–∞—Ä–µ–¥–∏ —à–∞–±–ª–æ–Ω</button>
  <button id="btnAddTemplate">‚ûï –®–∞–±–ª–æ–Ω —Å–ª—É–∂–∏—Ç–µ–ª</button>
  <button id="btnGenerate">üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button>
</div>

<table>
<thead>
<tr>
<th></th>
<th>–ò–º–µ</th>
<th>–ì—Ä—É–ø–∞</th>
<th>–†–æ–ª—è</th>
<th>–û—Å–Ω–æ–≤–Ω–∞</th>
<th>–ß–∞—Å/–º–µ—Å</th>
<th>–û—Ç—Ä–∞–±.</th>
<th>–ó–∞–ø–ª–∞—Ç–∞</th>
<th>–î–Ω–∏</th>
<th>–ü—ä—Ç–Ω–∏</th>
<th>–î–æ–±–∞–≤–∫–∏</th>
<th>–û—Å—Ç–∞—Ç—ä–∫</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="summary"></div>

<!-- ===== MODAL ADD TEMPLATE ===== -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <h3>–ù–æ–≤ —Å–ª—É–∂–∏—Ç–µ–ª (—à–∞–±–ª–æ–Ω)</h3>

    <label>–ò–º–µ:
      <input id="tplName">
    </label>

    <label>–ì—Ä—É–ø–∞:
      <select id="tplGroup"></select>
    </label>

    <label>–†–æ–ª—è:
      <select id="tplRole"></select>
    </label>

    <label>–û—Å–Ω–æ–≤–Ω–∞ –∑–∞–ø–ª–∞—Ç–∞:
      <input type="number" id="tplBase" value="0">
    </label>

    <button id="btnSaveTemplate">–ó–∞–ø–∞–∑–∏</button>
    <button onclick="closeTemplateModal()">–û—Ç–∫–∞–∑</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const GROUPS = ["–†–µ—Ü–µ–ø—Ü–∏—è","–î–æ–º–∞–∫–∏–Ω—Å—Ç–≤–æ","–†–µ—Å—Ç–æ—Ä–∞–Ω—Ç","–ü–æ–¥–¥—Ä—ä–∂–∫–∞"];
const ROLE_RULES = {
  "–†–µ—Ü–µ–ø—Ü–∏–æ–Ω–∏—Å—Ç":"hourly",
  "–ö–∞–º–µ—Ä–∏–µ—Ä–∫–∞":"daily",
  "–ü–æ–¥–¥—Ä—ä–∂–∫–∞":"fixed",
  "–°–µ–∑–æ–Ω–µ–Ω":"hourly"
};

const OBJECTS_KEY="zaplati_objects";
const STAFF_KEY=o=>`zaplati_staff_${o}`;

/* ===== HELPERS ===== */
const n=v=>Number(v)||0;
const f=v=>n(v).toFixed(2);

/* ===== ELEMENTS ===== */
const tbody=document.getElementById("tbody");
const objectSelect=document.getElementById("objectSelect");
const monthEl=document.getElementById("month");
const yearEl=document.getElementById("year");

/* ===== OBJECTS ===== */
function loadObjects(){
  const objs=JSON.parse(localStorage.getItem(OBJECTS_KEY)||'["–ï–∫–æ –∫–æ–º–ø–ª–µ–∫—Å –ó–¥—Ä–∞–≤–µ—Ü"]');
  objectSelect.innerHTML="";
  objs.forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o; opt.textContent=o;
    objectSelect.appendChild(opt);
  });
}

/* ===== TEMPLATE ===== */
function getTemplate(){
  return JSON.parse(localStorage.getItem(STAFF_KEY(objectSelect.value))||"[]");
}

function openTemplateModal(){
  document.getElementById("tplName").value="";
  document.getElementById("tplBase").value=0;

  const gSel=document.getElementById("tplGroup");
  const rSel=document.getElementById("tplRole");

  gSel.innerHTML=GROUPS.map(g=>`<option>${g}</option>`).join("");
  rSel.innerHTML=Object.keys(ROLE_RULES).map(r=>`<option>${r}</option>`).join("");

  document.getElementById("templateModal").style.display="flex";
}

function closeTemplateModal(){
  document.getElementById("templateModal").style.display="none";
}

function saveTemplateStaff(){
  const staff=getTemplate();
  staff.push({
    name:tplName.value,
    group:tplGroup.value,
    role:tplRole.value,
    base:n(tplBase.value)
  });
  localStorage.setItem(STAFF_KEY(objectSelect.value),JSON.stringify(staff));
  closeTemplateModal();
}

/* ===== ROW ===== */
function addRow(d={}){
  const tr=document.createElement("tr");
  tr.innerHTML=`
<td>::</td>
<td><input class="name" value="${d.name||""}"></td>
<td class="group">${d.group||""}</td>
<td class="role">${d.role||""}</td>
<td><input class="osn" type="number" value="${d.base||""}"></td>
<td><input class="chm" type="number"></td>
<td><input class="otr" type="number"></td>
<td class="zap">0.00</td>
<td><input class="dni" type="number"></td>
<td><input class="pat" type="number"></td>
<td><input class="dob" type="number" value="0"></td>
<td class="ostatak">0.00</td>`;
  tr.querySelectorAll("input").forEach(i=>i.oninput=()=>calc(tr));
  tbody.appendChild(tr);
}

/* ===== CALC ===== */
function calc(tr){
  const rule=ROLE_RULES[tr.querySelector(".role").textContent];
  const osn=n(tr.querySelector(".osn").value);
  const chm=n(tr.querySelector(".chm").value);
  const otr=n(tr.querySelector(".otr").value);
  const dni=n(tr.querySelector(".dni").value);
  const pat=n(tr.querySelector(".pat").value);
  const dob=n(tr.querySelector(".dob").value);

  let zap=0;
  if(rule==="hourly") zap=chm?osn/chm*otr:0;
  if(rule==="daily") zap=dni*osn;
  if(rule==="fixed") zap=osn;

  tr.querySelector(".zap").textContent=f(zap);
  tr.querySelector(".ostatak").textContent=f(zap+pat+dob);
}

/* ===== LOAD ===== */
function loadState(){
  tbody.innerHTML="";
  const raw=localStorage.getItem(`zaplati_${objectSelect.value}_${yearEl.value}_${monthEl.value}`);
  if(raw) JSON.parse(raw).forEach(r=>addRow(r));
  else getTemplate().forEach(s=>addRow(s));
  if(tbody.children.length===0) addRow();
}

/* ===== SUMMARY BY GROUP ===== */
function generateSummary(){
  const sums={};
  tbody.querySelectorAll("tr").forEach(tr=>{
    const g=tr.querySelector(".group").textContent||"–ë–µ–∑ –≥—Ä—É–ø–∞";
    sums[g]=(sums[g]||0)+n(tr.querySelector(".ostatak").textContent);
  });

  let html="<h3>–û–±–æ–±—â–µ–Ω–∏–µ –ø–æ –≥—Ä—É–ø–∏</h3><table><tr><th>–ì—Ä—É–ø–∞</th><th>–°—É–º–∞</th></tr>";
  let total=0;
  Object.keys(sums).forEach(g=>{
    html+=`<tr><td>${g}</td><td>${f(sums[g])}</td></tr>`;
    total+=sums[g];
  });
  html+=`<tr style="font-weight:bold"><td>–û–ë–©–û</td><td>${f(total)}</td></tr></table>`;
  document.getElementById("summary").innerHTML=html;
}

/* ===== EVENTS ===== */
btnAddRow.onclick=()=>addRow();
btnLoadTemplate.onclick=()=>getTemplate().forEach(s=>addRow(s));
btnAddTemplate.onclick=openTemplateModal;
btnSaveTemplate.onclick=saveTemplateStaff;
btnGenerate.onclick=generateSummary;

monthEl.onchange=loadState;
yearEl.oninput=loadState;
objectSelect.onchange=loadState;

/* ===== INIT ===== */
loadObjects();
loadState();
</script>

</body>
</html>
