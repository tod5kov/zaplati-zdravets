<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –í–µ–¥–æ–º–æ—Å—Ç –∏ —Ñ–∏—à–æ–≤–µ</title>

<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
h2,h3 { margin:8px 0; }

.toolbar {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:15px;
}

button, select, input {
  padding:6px 10px;
  border:1px solid #333;
  background:#fff;
  border-radius:6px;
}

table {
  border-collapse: collapse;
  width:100%;
  background:#fff;
}

th,td {
  border:1px solid #000;
  padding:5px;
  font-size:12px;
  text-align:center;
}

th { background:#e8eef5; }
input[type="number"] { width:80px; }
input.name { width:140px; }

tr.dragging { opacity:0.4; }

.fish {
  border:1px solid #000;
  padding:10px;
  margin:10px 0;
  page-break-inside:avoid;
}

.cut { border-top:2px dashed #000; margin:12px 0; }

/* ===== MODAL ===== */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  align-items:center;
  justify-content:center;
}

.modal-content {
  background:#fff;
  padding:15px;
  width:420px;
  max-height:80vh;
  overflow:auto;
  border-radius:8px;
}

.modal ul { list-style:none; padding:0; }

@media print {
  .toolbar, .modal { display:none !important; }
  body { background:#fff; padding:0; }
}
</style>
</head>

<body>

<h2>–ó–∞–ø–ª–∞—Ç–∏</h2>

<div class="toolbar">
  <label>–û–±–µ–∫—Ç:
    <select id="objectSelect"></select>
  </label>
  <button id="btnAddObject">‚ûï –û–±–µ–∫—Ç</button>

  <label>–ú–µ—Å–µ—Ü:
    <select id="month">
      <option>–Ø–Ω—É–∞—Ä–∏</option><option>–§–µ–≤—Ä—É–∞—Ä–∏</option><option>–ú–∞—Ä—Ç</option>
      <option>–ê–ø—Ä–∏–ª</option><option>–ú–∞–π</option><option>–Æ–Ω–∏</option>
      <option>–Æ–ª–∏</option><option>–ê–≤–≥—É—Å—Ç</option><option>–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
      <option>–û–∫—Ç–æ–º–≤—Ä–∏</option><option>–ù–æ–µ–º–≤—Ä–∏</option><option>–î–µ–∫–µ–º–≤—Ä–∏</option>
    </select>
  </label>

  <label>–ì–æ–¥–∏–Ω–∞:
    <input type="number" id="year" value="2025" style="width:80px;">
  </label>

  <button id="btnAddRow">‚ûï –°–ª—É–∂–∏—Ç–µ–ª</button>
  <button id="btnLoadTemplate">üß© –ó–∞—Ä–µ–¥–∏ —à–∞–±–ª–æ–Ω</button>
  <button id="btnAddTemplate">‚ûï –®–∞–±–ª–æ–Ω —Å–ª—É–∂–∏—Ç–µ–ª</button>
  <button id="btnEditTemplate">‚úèÔ∏è –†–µ–¥–∞–∫—Ü–∏—è —à–∞–±–ª–æ–Ω</button>
  <button id="btnGenerate">üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button>
</div>

<table>
<thead>
<tr>
<th></th>
<th>–ò–º–µ</th>
<th>–ì—Ä—É–ø–∞</th>
<th>–†–æ–ª—è</th>
<th>–û—Å–Ω–æ–≤–Ω–∞</th>
<th>–ß–∞—Å/–º–µ—Å</th>
<th>–û—Ç—Ä–∞–±.</th>
<th>–°—Ç–∞–≤–∫–∞</th>
<th>–ó–∞–ø–ª–∞—Ç–∞</th>
<th>–î–Ω–∏</th>
<th>–ü—ä—Ç–Ω–∏/–¥–µ–Ω</th>
<th>–ü—ä—Ç–Ω–∏</th>
<th>–î–æ–±–∞–≤–∫–∏</th>
<th>–û—Å—Ç–∞—Ç—ä–∫</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="fishes"></div>
<div id="summary"></div>

<!-- ===== MODAL ===== -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <h3>–®–∞–±–ª–æ–Ω —Å–ª—É–∂–∏—Ç–µ–ª–∏</h3>
    <ul id="templateList"></ul>
    <button id="btnDeleteTemplate">üóë –ò–∑—Ç—Ä–∏–π –∏–∑–±—Ä–∞–Ω–∏—Ç–µ</button>
    <button id="btnCloseModal">–ó–∞—Ç–≤–æ—Ä–∏</button>
  </div>
</div>

<script>
/* ===== ROLE RULES ===== */
const ROLE_RULES = {
  "–†–µ—Ü–µ–ø—Ü–∏–æ–Ω–∏—Å—Ç": "hourly",
  "–ö–∞–º–µ—Ä–∏–µ—Ä–∫–∞": "daily",
  "–ü–æ–¥–¥—Ä—ä–∂–∫–∞": "fixed",
  "–°–µ–∑–æ–Ω–µ–Ω": "hourly"
};

/* ===== HELPERS ===== */
const n = v => Number(v) || 0;
const f = v => n(v).toFixed(2);

/* ===== ELEMENTS ===== */
const tbody = document.getElementById("tbody");
const objectSelect = document.getElementById("objectSelect");
const monthEl = document.getElementById("month");
const yearEl = document.getElementById("year");

/* ===== STORAGE KEYS ===== */
const OBJECTS_KEY = "zaplati_objects";
const STAFF_KEY = o => `zaplati_staff_${o}`;
const DATA_KEY = () => `zaplati_${objectSelect.value}_${yearEl.value}_${monthEl.value}`;

/* ===== OBJECTS ===== */
function loadObjects() {
  const objs = JSON.parse(localStorage.getItem(OBJECTS_KEY) || '["–ï–∫–æ –∫–æ–º–ø–ª–µ–∫—Å –ó–¥—Ä–∞–≤–µ—Ü"]');
  objectSelect.innerHTML = "";
  objs.forEach(o => {
    const opt = document.createElement("option");
    opt.value = o;
    opt.textContent = o;
    objectSelect.appendChild(opt);
  });
}

function addObject() {
  const name = prompt("–ò–º–µ –Ω–∞ –æ–±–µ–∫—Ç–∞:");
  if (!name) return;
  const objs = JSON.parse(localStorage.getItem(OBJECTS_KEY) || "[]");
  if (!objs.includes(name)) objs.push(name);
  localStorage.setItem(OBJECTS_KEY, JSON.stringify(objs));
  loadObjects();
  objectSelect.value = name;
  loadState();
}

/* ===== TEMPLATE ===== */
function getTemplate() {
  return JSON.parse(localStorage.getItem(STAFF_KEY(objectSelect.value)) || "[]");
}

function loadTemplateIntoTable() {
  tbody.innerHTML = "";
  const tpl = getTemplate();
  if (tpl.length === 0) {
    addRow();
    return;
  }
  tpl.forEach(s => addRow(s));
}

function addTemplateStaff() {
  const name = prompt("–ò–º–µ:");
  if (!name) return;
  const group = prompt("–ì—Ä—É–ø–∞:");
  const role = prompt("–†–æ–ª—è:");
  if (!ROLE_RULES[role]) return alert("–ù–µ–ø–æ–∑–Ω–∞—Ç–∞ —Ä–æ–ª—è");
  const base = n(prompt("–û—Å–Ω–æ–≤–Ω–∞ –∑–∞–ø–ª–∞—Ç–∞:", "0"));
  const staff = getTemplate();
  staff.push({ name, group, role, base });
  localStorage.setItem(STAFF_KEY(objectSelect.value), JSON.stringify(staff));
}

function openTemplateModal() {
  const list = document.getElementById("templateList");
  list.innerHTML = "";
  getTemplate().forEach((s,i)=>{
    const li=document.createElement("li");
    li.innerHTML=`<label><input type="checkbox" value="${i}"> ${s.name} ‚Äì ${s.group} ‚Äì ${s.role}</label>`;
    list.appendChild(li);
  });
  document.getElementById("templateModal").style.display="flex";
}

function deleteTemplateStaff() {
  let staff = getTemplate();
  const checked = [...document.querySelectorAll("#templateList input:checked")]
    .map(c=>Number(c.value));
  staff = staff.filter((_,i)=>!checked.includes(i));
  localStorage.setItem(STAFF_KEY(objectSelect.value), JSON.stringify(staff));
  closeModal();
}

function closeModal() {
  document.getElementById("templateModal").style.display="none";
}

/* ===== ROWS ===== */
function addRow(data={}) {
  const tr=document.createElement("tr");
  tr.draggable=true;
  tr.innerHTML=`
<td>::</td>
<td><input class="name" value="${data.name||""}"></td>
<td>${data.group||""}</td>
<td class="role">${data.role||""}</td>
<td><input type="number" class="osn" value="${data.base||""}"></td>
<td><input type="number" class="chm"></td>
<td><input type="number" class="otr"></td>
<td class="stavka">0.00</td>
<td class="zap">0.00</td>
<td><input type="number" class="dni"></td>
<td><input type="number" class="pden"></td>
<td class="patni">0.00</td>
<td><input type="number" class="dob" value="0"></td>
<td class="ostatak">0.00</td>`;
  tr.querySelectorAll("input").forEach(i=>i.addEventListener("input",()=>calc(tr)));
  enableDrag(tr);
  tbody.appendChild(tr);
  calc(tr);
}

/* ===== DRAG ===== */
function enableDrag(tr) {
  tr.addEventListener("dragstart",()=>tr.classList.add("dragging"));
  tr.addEventListener("dragend",()=>tr.classList.remove("dragging"));
  tbody.addEventListener("dragover",e=>{
    e.preventDefault();
    const after=[...tbody.querySelectorAll("tr:not(.dragging)")]
      .find(r=>e.clientY<r.getBoundingClientRect().top+r.offsetHeight/2);
    const d=tbody.querySelector(".dragging");
    if(!d) return;
    after?tbody.insertBefore(d,after):tbody.appendChild(d);
  });
}

/* ===== CALC ===== */
function calc(tr) {
  const role = tr.querySelector(".role").textContent;
  const rule = ROLE_RULES[role];

  const osn=n(tr.querySelector(".osn").value);
  const chm=n(tr.querySelector(".chm").value);
  const otr=n(tr.querySelector(".otr").value);
  const dni=n(tr.querySelector(".dni").value);
  const pden=n(tr.querySelector(".pden").value);
  const dob=n(tr.querySelector(".dob").value);

  let zap=0,stavka=0;

  if(rule==="hourly") {
    stavka=chm?osn/chm:0;
    zap=stavka*otr;
  }
  if(rule==="daily") zap=dni*osn;
  if(rule==="fixed") zap=osn;

  const patni=dni*pden;
  const total=zap+patni+dob;

  tr.querySelector(".stavka").textContent=f(stavka);
  tr.querySelector(".zap").textContent=f(zap);
  tr.querySelector(".patni").textContent=f(patni);
  tr.querySelector(".ostatak").textContent=f(total);
}

/* ===== SAVE / LOAD ===== */
function saveState() {
  const rows=[];
  tbody.querySelectorAll("tr").forEach(tr=>{
    rows.push({
      name:tr.querySelector(".name").value,
      group:tr.children[2].textContent,
      role:tr.querySelector(".role").textContent,
      base:tr.querySelector(".osn").value
    });
  });
  localStorage.setItem(DATA_KEY(),JSON.stringify(rows));
}

function loadState() {
  tbody.innerHTML="";
  const raw=localStorage.getItem(DATA_KEY());
  if(raw) JSON.parse(raw).forEach(r=>addRow(r));
  else loadTemplateIntoTable();
}

/* ===== OUTPUT ===== */
function generateAll() {
  let total=0;
  document.getElementById("fishes").innerHTML="";
  tbody.querySelectorAll("tr").forEach(tr=>{
    calc(tr);
    total+=n(tr.querySelector(".ostatak").textContent);
  });
  document.getElementById("summary").innerHTML=
    `<h3>–û–±—â–æ –∑–∞ –∏–∑–ø–ª–∞—â–∞–Ω–µ: ${f(total)} –ª–≤.</h3>`;
}

/* ===== EVENTS ===== */
document.getElementById("btnAddObject").addEventListener("click",addObject);
document.getElementById("btnAddRow").addEventListener("click",()=>addRow());
document.getElementById("btnLoadTemplate").addEventListener("click",loadTemplateIntoTable);
document.getElementById("btnAddTemplate").addEventListener("click",addTemplateStaff);
document.getElementById("btnEditTemplate").addEventListener("click",openTemplateModal);
document.getElementById("btnDeleteTemplate").addEventListener("click",deleteTemplateStaff);
document.getElementById("btnCloseModal").addEventListener("click",closeModal);
document.getElementById("btnGenerate").addEventListener("click",generateAll);

monthEl.addEventListener("change",loadState);
yearEl.addEventListener("input",loadState);
objectSelect.addEventListener("change",loadState);

/* ===== INIT ===== */
loadObjects();
loadState();
</script>

</body>
</html>
