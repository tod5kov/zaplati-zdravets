<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –í–µ–¥–æ–º–æ—Å—Ç, —Ñ–∏—à–æ–≤–µ, —à–∞–±–ª–æ–Ω–∏</title>

<style>
  body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
  h2,h3 { margin:8px 0; }

  .toolbar {
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    margin:10px 0 15px;
  }

  button, select, input {
    padding:6px 10px; border:1px solid #333; background:#fff; border-radius:6px;
  }
  button { cursor:pointer; }
  button:hover { background:#eee; }

  table { border-collapse: collapse; width:100%; background:#fff; }
  th,td { border:1px solid #000; padding:5px; font-size:12px; text-align:center; }
  th { background:#e8eef5; }

  input[type="number"] { width:86px; }
  input.name { width:170px; }

  tr.dragging { opacity: .4; }

  .section { margin-top:18px; }

  .fish { border:1px solid #000; padding:10px; margin:10px 0; page-break-inside:avoid; background:#fff; }
  .cut { border-top:2px dashed #000; margin:12px 0; }

  .muted { color:#555; font-size:12px; }

  /* ===== MODALS ===== */
  .modal {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    align-items:center;
    justify-content:center;
    z-index: 999;
  }
  .modal-content {
    background:#fff;
    padding:14px;
    width:min(820px, 94vw);
    max-height:86vh;
    overflow:auto;
    border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .modal h3 { margin-top:0; }
  .grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px 12px;
    margin-top:10px;
  }
  .grid label { display:block; font-size:12px; color:#222; }
  .grid input, .grid select { width:100%; margin-top:4px; }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap; }

  .tpl-table { width:100%; border-collapse:collapse; background:#fff; margin-top:8px; }
  .tpl-table th, .tpl-table td { border:1px solid #999; padding:6px; font-size:12px; }
  .tpl-table th { background:#f2f2f2; }
  .tpl-left { text-align:left; }

  @media print {
    .toolbar, .no-print, .modal { display:none !important; }
    body { background:#fff; padding:0; }
    .page-break { page-break-after: always; }
  }
</style>
</head>

<body>
  <h2>–ó–∞–ø–ª–∞—Ç–∏</h2>

  <div class="toolbar no-print">
    <label>–û–±–µ–∫—Ç:
      <select id="objectSelect"></select>
    </label>
    <button id="btnAddObject">‚ûï –û–±–µ–∫—Ç</button>

    <label>–ú–µ—Å–µ—Ü:
      <select id="month">
        <option>–Ø–Ω—É–∞—Ä–∏</option><option>–§–µ–≤—Ä—É–∞—Ä–∏</option><option>–ú–∞—Ä—Ç</option>
        <option>–ê–ø—Ä–∏–ª</option><option>–ú–∞–π</option><option>–Æ–Ω–∏</option>
        <option>–Æ–ª–∏</option><option>–ê–≤–≥—É—Å—Ç</option><option>–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
        <option>–û–∫—Ç–æ–º–≤—Ä–∏</option><option>–ù–æ–µ–º–≤—Ä–∏</option><option>–î–µ–∫–µ–º–≤—Ä–∏</option>
      </select>
    </label>

    <label>–ì–æ–¥–∏–Ω–∞:
      <input type="number" id="year" value="2025" style="width:90px;">
    </label>

    <button id="btnAddRow">‚ûï –°–ª—É–∂–∏—Ç–µ–ª</button>
    <button id="btnLoadTemplate">üß© –ó–∞—Ä–µ–¥–∏ —à–∞–±–ª–æ–Ω</button>
    <button id="btnManageTemplate">üë§ –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Å–ª—É–∂–∏—Ç–µ–ª–∏</button>

    <button id="btnGenerate">üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button>
    <button id="btnPrint">üñ® –ü–µ—á–∞—Ç</button>
  </div>

  <div class="muted no-print">
    ‚Ä¢ –ù–µ—Ç–Ω–æ = –ó–∞–ø–ª–∞—Ç–∞ + –ü—ä—Ç–Ω–∏ + –î–æ–±–∞–≤–∫–∏ ‚àí –ê–≤–∞–Ω—Å ‚àí –£–¥—Ä—ä–∂–∫–∏<br>
    ‚Ä¢ daily: –ó–∞–ø–ª–∞—Ç–∞ = <b>–ó–∞–ø–ª. –¥–Ω–∏ √ó –ó–∞–ø–ª. —Å—Ç–∞–≤–∫–∞/–¥–µ–Ω</b><br>
    ‚Ä¢ –ü—ä—Ç–Ω–∏: –ü—ä—Ç–Ω–∏ = <b>–ü—ä—Ç–Ω–∏ –¥–Ω–∏ √ó –ü—ä—Ç–Ω–∏/–¥–µ–Ω</b><br>
    ‚Ä¢ –û—Å—Ç–∞—Ç—ä–∫ = <b>–ù–µ—Ç–Ω–æ ‚àí –ü–ª–∞—Ç–µ–Ω–∞ –∑–∞–ø–ª–∞—Ç–∞</b>
  </div>

  <!-- ================== MAIN TABLE ================== -->
  <table>
    <thead>
      <tr>
        <th></th>
        <th>–ò–º–µ</th>
        <th>–ì—Ä—É–ø–∞</th>
        <th>–†–æ–ª—è</th>

        <th>–û—Å–Ω–æ–≤–Ω–∞</th>
        <th>–ß–∞—Å/–º–µ—Å</th>
        <th>–û—Ç—Ä–∞–±.</th>
        <th>–°—Ç–∞–≤–∫–∞/—á–∞—Å</th>

        <th>–ó–∞–ø–ª. –¥–Ω–∏</th>
        <th>–ó–∞–ø–ª. —Å—Ç–∞–≤–∫–∞/–¥–µ–Ω</th>

        <th>–ó–∞–ø–ª–∞—Ç–∞</th>

        <th>–ü—ä—Ç–Ω–∏ –¥–Ω–∏</th>
        <th>–ü—ä—Ç–Ω–∏/–¥–µ–Ω</th>
        <th>–ü—ä—Ç–Ω–∏</th>

        <th>–î–æ–±–∞–≤–∫–∏</th>
        <th>–ê–≤–∞–Ω—Å</th>
        <th>–£–¥—Ä—ä–∂–∫–∏</th>

        <th>–ù–µ—Ç–Ω–æ</th>
        <th>–ü–ª–∞—Ç–µ–Ω–∞ –∑–∞–ø–ª–∞—Ç–∞</th>
        <th>–û—Å—Ç–∞—Ç—ä–∫</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- ================== OUTPUT ================== -->
  <div id="fishes" class="section"></div>
  <div id="summary" class="section"></div>

  <!-- ================== TEMPLATE MANAGER MODAL ================== -->
  <div id="tplModal" class="modal">
    <div class="modal-content">
      <h3>–®–∞–±–ª–æ–Ω —Å–ª—É–∂–∏—Ç–µ–ª–∏ ‚Äì <span id="tplObjectName"></span></h3>
      <div class="muted">
        –®–∞–±–ª–æ–Ω—ä—Ç –ø–∞–∑–∏: –ò–º–µ, –ì—Ä—É–ø–∞, –†–æ–ª—è, –û—Å–Ω–æ–≤–Ω–∞ (–∑–∞ fixed/hourly) –∏ –ó–∞–ø–ª. —Å—Ç–∞–≤–∫–∞/–¥–µ–Ω (–∑–∞ daily).
        –ü—ä—Ç–Ω–∏—Ç–µ –∏ –ø–ª–∞—â–∞–Ω–∏—è—Ç–∞ —Å–∞ –º–µ—Å–µ—á–Ω–∏ –∏ —Å–µ –ø–æ–ø—ä–ª–≤–∞—Ç –≤—ä–≤ –≤–µ–¥–æ–º–æ—Å—Ç—Ç–∞.
      </div>

      <div class="modal-actions" style="justify-content:space-between;">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnTplAdd">‚ûï –ù–æ–≤ —Å–ª—É–∂–∏—Ç–µ–ª</button>
          <button id="btnTplDeleteSelected">üóë –ò–∑—Ç—Ä–∏–π –∏–∑–±—Ä–∞–Ω–∏—Ç–µ</button>
        </div>
        <button id="btnTplClose">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>

      <table class="tpl-table" aria-label="template table">
        <thead>
          <tr>
            <th style="width:34px;">‚úì</th>
            <th class="tpl-left">–ò–º–µ</th>
            <th>–ì—Ä—É–ø–∞</th>
            <th>–†–æ–ª—è</th>
            <th>–û—Å–Ω–æ–≤–Ω–∞</th>
            <th>–ó–∞–ø–ª. —Å—Ç–∞–≤–∫–∞/–¥–µ–Ω</th>
            <th style="width:92px;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="tplTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ================== TEMPLATE EDIT/ADD MODAL ================== -->
  <div id="tplEditModal" class="modal">
    <div class="modal-content">
      <h3 id="tplEditTitle">–°–ª—É–∂–∏—Ç–µ–ª (—à–∞–±–ª–æ–Ω)</h3>

      <div class="grid">
        <div>
          <label>–ò–º–µ
            <input id="tplName" />
          </label>
        </div>

        <div>
          <label>–ì—Ä—É–ø–∞
            <select id="tplGroup"></select>
          </label>
        </div>

        <div>
          <label>–†–æ–ª—è
            <select id="tplRole"></select>
          </label>
        </div>

        <div>
          <label>–û—Å–Ω–æ–≤–Ω–∞ –∑–∞–ø–ª–∞—Ç–∞ (–∑–∞ hourly/fixed)
            <input type="number" id="tplBase" value="0" />
          </label>
        </div>

        <div>
          <label>–ó–∞–ø–ª. —Å—Ç–∞–≤–∫–∞/–¥–µ–Ω (—Å–∞–º–æ –∑–∞ daily)
            <input type="number" id="tplSalaryDayRate" value="0" />
          </label>
        </div>

        <div class="muted" style="align-self:end;">
          daily: –ó–∞–ø–ª–∞—Ç–∞ = <b>–ó–∞–ø–ª. –¥–Ω–∏ √ó –ó–∞–ø–ª. —Å—Ç–∞–≤–∫–∞/–¥–µ–Ω</b>
        </div>
      </div>

      <div class="modal-actions">
        <button id="btnTplSave">–ó–∞–ø–∞–∑–∏</button>
        <button id="btnTplCancel">–û—Ç–∫–∞–∑</button>
      </div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const GROUPS = ["–†–µ—Ü–µ–ø—Ü–∏—è","–î–æ–º–∞–∫–∏–Ω—Å—Ç–≤–æ","–†–µ—Å—Ç–æ—Ä–∞–Ω—Ç","–ü–æ–¥–¥—Ä—ä–∂–∫–∞"];

const ROLE_RULES = {
  "–†–µ—Ü–µ–ø—Ü–∏–æ–Ω–∏—Å—Ç": "hourly",
  "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä": "hourly",
  "–ö–∞–º–µ—Ä–∏–µ—Ä–∫–∞": "daily",
  "–ü–æ–¥–¥—Ä—ä–∂–∫–∞": "fixed",
  "–°–µ–∑–æ–Ω–µ–Ω": "hourly"
};

const OBJECTS_KEY = "zaplati_objects";
const STAFF_KEY = (obj) => `zaplati_staff_${obj}`;

/* ================= HELPERS ================= */
const n = (v) => Number(v) || 0;
const f = (v) => (Math.round((n(v) + Number.EPSILON) * 100) / 100).toFixed(2);

function esc(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

/* ================= ELEMENTS ================= */
const tbody = document.getElementById("tbody");
const objectSelect = document.getElementById("objectSelect");
const monthEl = document.getElementById("month");
const yearEl = document.getElementById("year");

const fishesEl = document.getElementById("fishes");
const summaryEl = document.getElementById("summary");

/* ================= STORAGE KEYS ================= */
function dataKey(obj = objectSelect.value, y = yearEl.value, m = monthEl.value) {
  return `zaplati_${obj}_${y}_${m}`;
}

/* ================= OBJECTS ================= */
function loadObjects() {
  const objs = JSON.parse(localStorage.getItem(OBJECTS_KEY) || '["–ï–∫–æ –∫–æ–º–ø–ª–µ–∫—Å –ó–¥—Ä–∞–≤–µ—Ü"]');
  objectSelect.innerHTML = "";
  objs.forEach(o => {
    const opt = document.createElement("option");
    opt.value = o;
    opt.textContent = o;
    objectSelect.appendChild(opt);
  });
}

function addObject() {
  const name = prompt("–ò–º–µ –Ω–∞ –æ–±–µ–∫—Ç–∞:");
  if (!name) return;
  const objs = JSON.parse(localStorage.getItem(OBJECTS_KEY) || "[]");
  if (!objs.includes(name)) objs.push(name);
  localStorage.setItem(OBJECTS_KEY, JSON.stringify(objs));
  loadObjects();
  objectSelect.value = name;
  loadState();
}

/* ================= TEMPLATE DATA ================= */
function getTemplate(obj = objectSelect.value) {
  // {name, group, role, base, salaryDayRate}
  return JSON.parse(localStorage.getItem(STAFF_KEY(obj)) || "[]");
}

function setTemplate(list, obj = objectSelect.value) {
  localStorage.setItem(STAFF_KEY(obj), JSON.stringify(list));
}

/* ================= TEMPLATE UI ================= */
const tplModal = document.getElementById("tplModal");
const tplObjectName = document.getElementById("tplObjectName");
const tplTableBody = document.getElementById("tplTableBody");

const tplEditModal = document.getElementById("tplEditModal");
const tplEditTitle = document.getElementById("tplEditTitle");
const tplName = document.getElementById("tplName");
const tplGroup = document.getElementById("tplGroup");
const tplRole = document.getElementById("tplRole");
const tplBase = document.getElementById("tplBase");
const tplSalaryDayRate = document.getElementById("tplSalaryDayRate");

let tplEditIndex = null;

function openTplModal() {
  tplObjectName.textContent = objectSelect.value;
  renderTplTable();
  tplModal.style.display = "flex";
}

function closeTplModal() {
  tplModal.style.display = "none";
}

function openTplEditModal(index = null) {
  tplEditIndex = index;

  tplGroup.innerHTML = GROUPS.map(g => `<option value="${esc(g)}">${esc(g)}</option>`).join("");
  tplRole.innerHTML = Object.keys(ROLE_RULES).map(r => `<option value="${esc(r)}">${esc(r)}</option>`).join("");

  if (index === null) {
    tplEditTitle.textContent = "–ù–æ–≤ —Å–ª—É–∂–∏—Ç–µ–ª (—à–∞–±–ª–æ–Ω)";
    tplName.value = "";
    tplGroup.value = GROUPS[0] || "";
    tplRole.value = Object.keys(ROLE_RULES)[0] || "";
    tplBase.value = 0;
    tplSalaryDayRate.value = 0;
  } else {
    const list = getTemplate();
    const item = list[index] || {};
    tplEditTitle.textContent = "–†–µ–¥–∞–∫—Ü–∏—è —Å–ª—É–∂–∏—Ç–µ–ª (—à–∞–±–ª–æ–Ω)";
    tplName.value = item.name || "";
    tplGroup.value = item.group || (GROUPS[0] || "");
    tplRole.value = item.role || (Object.keys(ROLE_RULES)[0] || "");
    tplBase.value = n(item.base);
    tplSalaryDayRate.value = n(item.salaryDayRate);
  }

  tplEditModal.style.display = "flex";
}

function closeTplEditModal() {
  tplEditModal.style.display = "none";
}

function saveTplEdit() {
  const name = (tplName.value || "").trim();
  if (!name) { alert("–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ –∏–º–µ."); return; }

  const item = {
    name,
    group: tplGroup.value,
    role: tplRole.value,
    base: n(tplBase.value),
    salaryDayRate: n(tplSalaryDayRate.value)
  };

  const list = getTemplate();
  if (tplEditIndex === null) list.push(item);
  else list[tplEditIndex] = item;

  setTemplate(list);
  closeTplEditModal();
  renderTplTable();
}

function deleteSelectedTpl() {
  const list = getTemplate();
  const checked = Array.from(document.querySelectorAll(".tpl-check:checked")).map(c => Number(c.value));
  if (checked.length === 0) { alert("–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω–∏ —Å–ª—É–∂–∏—Ç–µ–ª–∏."); return; }
  if (!confirm(`–î–∞ –∏–∑—Ç—Ä–∏—è ${checked.length} —Å–ª—É–∂–∏—Ç–µ–ª—è –æ—Ç —à–∞–±–ª–æ–Ω–∞?`)) return;

  const newList = list.filter((_, idx) => !checked.includes(idx));
  setTemplate(newList);
  renderTplTable();
}

function renderTplTable() {
  const list = getTemplate();
  tplTableBody.innerHTML = "";

  if (list.length === 0) {
    tplTableBody.innerHTML = `<tr><td colspan="7" class="tpl-left"><i>–ù—è–º–∞ —Å–ª—É–∂–∏—Ç–µ–ª–∏ –≤ —à–∞–±–ª–æ–Ω–∞ –∑–∞ —Ç–æ–∑–∏ –æ–±–µ–∫—Ç.</i></td></tr>`;
    return;
  }

  list.forEach((s, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="tpl-check" type="checkbox" value="${i}"></td>
      <td class="tpl-left">${esc(s.name)}</td>
      <td>${esc(s.group)}</td>
      <td>${esc(s.role)}</td>
      <td>${f(s.base)}</td>
      <td>${f(s.salaryDayRate)}</td>
      <td><button class="tpl-edit-btn" data-index="${i}">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button></td>
    `;
    tplTableBody.appendChild(tr);
  });

  tplTableBody.querySelectorAll(".tpl-edit-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const idx = Number(e.currentTarget.getAttribute("data-index"));
      openTplEditModal(idx);
    });
  });
}

/* ================= ROWS (Main Table) ================= */
function buildRow(prefill = {}) {
  const tr = document.createElement("tr");
  tr.draggable = true;

  tr.innerHTML = `
    <td>::</td>
    <td><input class="name" value="${esc(prefill.name || "")}"></td>
    <td class="group">${esc(prefill.group || "")}</td>
    <td class="role">${esc(prefill.role || "")}</td>

    <td><input type="number" class="base" value="${prefill.base ?? ""}"></td>
    <td><input type="number" class="hoursMonth" value="${prefill.hoursMonth ?? ""}"></td>
    <td><input type="number" class="hoursWorked" value="${prefill.hoursWorked ?? ""}"></td>
    <td class="hourRate">0.00</td>

    <td><input type="number" class="salaryDays" value="${prefill.salaryDays ?? ""}"></td>
    <td><input type="number" class="salaryDayRate" value="${prefill.salaryDayRate ?? 0}"></td>

    <td class="salary">0.00</td>

    <td><input type="number" class="travelDays" value="${prefill.travelDays ?? ""}"></td>
    <td><input type="number" class="travelDayRate" value="${prefill.travelDayRate ?? 0}"></td>
    <td class="travel">0.00</td>

    <td><input type="number" class="bonus" value="${prefill.bonus ?? 0}"></td>
    <td><input type="number" class="advance" value="${prefill.advance ?? 0}"></td>
    <td><input type="number" class="deduct" value="${prefill.deduct ?? 0}"></td>

    <td class="net">0.00</td>

    <td><input type="number" class="paid" value="${prefill.paid ?? 0}"></td>
    <td class="remaining">0.00</td>
  `;

  tr.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", () => {
      calcRow(tr);
      saveState();
    });
  });

  enableDrag(tr);
  return tr;
}

function addRow(prefill = {}) {
  const tr = buildRow(prefill);
  tbody.appendChild(tr);
  calcRow(tr);
  saveState();
}

function enableDrag(tr) {
  tr.addEventListener("dragstart", () => tr.classList.add("dragging"));
  tr.addEventListener("dragend", () => { tr.classList.remove("dragging"); saveState(); });

  tbody.addEventListener("dragover", (e) => {
    e.preventDefault();
    const dragging = tbody.querySelector(".dragging");
    if (!dragging) return;

    const rows = [...tbody.querySelectorAll("tr:not(.dragging)")];
    const after = rows.find(r => e.clientY < r.getBoundingClientRect().top + r.offsetHeight / 2);
    after ? tbody.insertBefore(dragging, after) : tbody.appendChild(dragging);
  }, { passive: false });
}

/* ================= CALC ================= */
function calcRow(tr) {
  const role = tr.querySelector(".role").textContent.trim();
  const rule = ROLE_RULES[role] || "hourly";

  const base = n(tr.querySelector(".base").value);
  const hoursMonth = n(tr.querySelector(".hoursMonth").value);
  const hoursWorked = n(tr.querySelector(".hoursWorked").value);

  const salaryDays = n(tr.querySelector(".salaryDays").value);
  const salaryDayRate = n(tr.querySelector(".salaryDayRate").value);

  const travelDays = n(tr.querySelector(".travelDays").value);
  const travelDayRate = n(tr.querySelector(".travelDayRate").value);

  const bonus = n(tr.querySelector(".bonus").value);
  const advance = n(tr.querySelector(".advance").value);
  const deduct = n(tr.querySelector(".deduct").value);

  const paid = n(tr.querySelector(".paid").value);

  let hourRate = 0;
  let salary = 0;

  if (rule === "hourly") {
    hourRate = hoursMonth ? base / hoursMonth : 0;
    salary = hourRate * hoursWorked;
  } else if (rule === "daily") {
    salary = salaryDays * salaryDayRate;
  } else if (rule === "fixed") {
    salary = base;
  }

  const travel = travelDays * travelDayRate;
  const net = salary + travel + bonus - advance - deduct;
  const remaining = net - paid;

  tr.querySelector(".hourRate").textContent = f(hourRate);
  tr.querySelector(".salary").textContent = f(salary);
  tr.querySelector(".travel").textContent = f(travel);
  tr.querySelector(".net").textContent = f(net);
  tr.querySelector(".remaining").textContent = f(remaining);
}

/* ================= SAVE / LOAD ================= */
function collectState() {
  const rows = [];
  tbody.querySelectorAll("tr").forEach(tr => {
    rows.push({
      name: tr.querySelector(".name").value,
      group: tr.querySelector(".group").textContent,
      role: tr.querySelector(".role").textContent,

      base: tr.querySelector(".base").value,
      hoursMonth: tr.querySelector(".hoursMonth").value,
      hoursWorked: tr.querySelector(".hoursWorked").value,

      salaryDays: tr.querySelector(".salaryDays").value,
      salaryDayRate: tr.querySelector(".salaryDayRate").value,

      travelDays: tr.querySelector(".travelDays").value,
      travelDayRate: tr.querySelector(".travelDayRate").value,

      bonus: tr.querySelector(".bonus").value,
      advance: tr.querySelector(".advance").value,
      deduct: tr.querySelector(".deduct").value,

      paid: tr.querySelector(".paid").value
    });
  });
  return rows;
}

function saveState() {
  try {
    localStorage.setItem(dataKey(), JSON.stringify(collectState()));
  } catch (e) {}
}

function loadTemplateIntoTable() {
  tbody.innerHTML = "";
  const tpl = getTemplate();
  if (tpl.length === 0) return;

  tpl.forEach(s => {
    addRow({
      name: s.name,
      group: s.group,
      role: s.role,

      base: s.base ?? 0,
      salaryDayRate: s.salaryDayRate ?? 0,

      hoursMonth: "",
      hoursWorked: "",
      salaryDays: "",

      travelDays: "",
      travelDayRate: 0,

      bonus: 0,
      advance: 0,
      deduct: 0,

      paid: 0
    });
  });
}

function loadState() {
  fishesEl.innerHTML = "";
  summaryEl.innerHTML = "";

  tbody.innerHTML = "";
  const raw = localStorage.getItem(dataKey());
  if (raw) {
    try {
      const rows = JSON.parse(raw);
      rows.forEach(r => tbody.appendChild(buildRow(r)));
      tbody.querySelectorAll("tr").forEach(calcRow);
    } catch (e) {}
  } else {
    loadTemplateIntoTable();
  }

  if (tbody.children.length === 0) addRow();
  else saveState();
}

/* ================= OUTPUT: FISHES + SUMMARY ================= */
function generateAll() {
  tbody.querySelectorAll("tr").forEach(calcRow);
  generateFishes();
  generateSummary();
}

function generateFishes() {
  const obj = objectSelect.value;
  const m = monthEl.value;
  const y = yearEl.value;

  let html = `<h3>–§–∏—à–æ–≤–µ ‚Äì ${esc(obj)} / ${esc(m)} ${esc(y)}</h3>`;
  let count = 0;

  tbody.querySelectorAll("tr").forEach((tr) => {
    const name = (tr.querySelector(".name").value || "").trim();
    if (!name) return;

    count++;

    html += `
      <div class="fish">
        <b>–°–ª—É–∂–∏—Ç–µ–ª:</b> ${esc(name)}<br>
        <b>–ì—Ä—É–ø–∞:</b> ${esc(tr.querySelector(".group").textContent)}<br>
        <b>–†–æ–ª—è:</b> ${esc(tr.querySelector(".role").textContent)}<br>
        <b>–û–±–µ–∫—Ç:</b> ${esc(obj)}<br>
        <b>–ü–µ—Ä–∏–æ–¥:</b> ${esc(m)} ${esc(y)}<br>
        <hr>
        <b>–ó–∞–ø–ª–∞—Ç–∞:</b> ${tr.querySelector(".salary").textContent} –ª–≤.<br>
        <b>–ü—ä—Ç–Ω–∏:</b> ${tr.querySelector(".travel").textContent} –ª–≤.<br>
        <b>–î–æ–±–∞–≤–∫–∏:</b> ${f(tr.querySelector(".bonus").value)} –ª–≤.<br>
        <b>–ê–≤–∞–Ω—Å:</b> ${f(tr.querySelector(".advance").value)} –ª–≤.<br>
        <b>–£–¥—Ä—ä–∂–∫–∏:</b> ${f(tr.querySelector(".deduct").value)} –ª–≤.<br>
        <hr>
        <b>–ù–µ—Ç–Ω–æ:</b> ${tr.querySelector(".net").textContent} –ª–≤.<br>
        <b>–ü–ª–∞—Ç–µ–Ω–æ:</b> ${f(tr.querySelector(".paid").value)} –ª–≤.<br>
        <b>–û—Å—Ç–∞—Ç—ä–∫:</b> ${tr.querySelector(".remaining").textContent} –ª–≤.
      </div>
      <div class="cut"></div>
    `;

    if (count % 3 === 0) html += `<div class="page-break"></div>`;
  });

  if (count === 0) html += `<p><i>–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ —Å–ª—É–∂–∏—Ç–µ–ª–∏ (–ø–æ–ø—ä–ª–Ω–∏ –ø–æ–Ω–µ –∏–º–µ).</i></p>`;
  fishesEl.innerHTML = html;
}

function generateSummary() {
  const obj = objectSelect.value;
  const m = monthEl.value;
  const y = yearEl.value;

  const byGroup = {};
let totalNet = 0, totalPaid = 0, totalRem = 0;
let totalCost = 0; // üëà –û–ë–©–ê –°–£–ú–ê –ó–ê –ó–ê–ü–õ–ê–¢–ò

  tbody.querySelectorAll("tr").forEach(tr => {
    const name = (tr.querySelector(".name").value || "").trim();
    if (!name) return;

    const g = (tr.querySelector(".group").textContent || "–ë–µ–∑ –≥—Ä—É–ø–∞").trim() || "–ë–µ–∑ –≥—Ä—É–ø–∞";
    const net = n(tr.querySelector(".net").textContent);
    const paid = n(tr.querySelector(".paid").value);
    const rem = n(tr.querySelector(".remaining").textContent);

    if (!byGroup[g]) byGroup[g] = { net: 0, paid: 0, rem: 0 };
    byGroup[g].net += net;
    byGroup[g].paid += paid;
    byGroup[g].rem += rem;

    totalNet += net;
    totalPaid += paid;
    totalRem += rem;
  });

  const groups = Object.keys(byGroup).sort((a,b) => a.localeCompare(b, "bg"));
  const rows = groups.length
    ? groups.map(g => `
        <tr>
          <td style="text-align:left;padding-left:8px;">${esc(g)}</td>
          <td>${f(byGroup[g].net)}</td>
          <td>${f(byGroup[g].paid)}</td>
          <td>${f(byGroup[g].rem)}</td>
        </tr>
      `).join("")
    : `<tr><td colspan="4"><i>–ù—è–º–∞ –¥–∞–Ω–Ω–∏.</i></td></tr>`;

  summaryEl.innerHTML = `
    <h3>–û–±–æ–±—â–µ–Ω–∞ –≤–µ–¥–æ–º–æ—Å—Ç ‚Äì ${esc(obj)} / ${esc(m)} ${esc(y)}</h3>

    <table style="margin-top:6px;">
      <thead>
        <tr>
          <th style="text-align:left;padding-left:8px;">–ì—Ä—É–ø–∞</th>
          <th>–ù–µ—Ç–Ω–æ</th>
          <th>–ü–ª–∞—Ç–µ–Ω–æ</th>
          <th>–û—Å—Ç–∞—Ç—ä–∫</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
        <tr style="font-weight:bold;background:#eee;">
          <td style="text-align:left;padding-left:8px;">–û–ë–©–û</td>
          <td>${f(totalNet)}</td>
          <td>${f(totalPaid)}</td>
          <td>${f(totalRem)}</td>
        </tr>
      </tbody>
    </table>

    <p style="margin-top:26px;">
      –°—ä—Å—Ç–∞–≤–∏–ª: ________________ &nbsp;&nbsp; –ü—Ä–æ–≤–µ—Ä–∏–ª: ________________
    </p>
  `;
}

/* ================= EVENTS ================= */
document.getElementById("btnAddObject").addEventListener("click", addObject);
document.getElementById("btnAddRow").addEventListener("click", () => addRow());

document.getElementById("btnLoadTemplate").addEventListener("click", () => {
  loadTemplateIntoTable();
  if (tbody.children.length === 0) addRow();
  saveState();
});

document.getElementById("btnManageTemplate").addEventListener("click", openTplModal);
document.getElementById("btnGenerate").addEventListener("click", generateAll);

document.getElementById("btnPrint").addEventListener("click", () => {
  generateAll();
  window.print();
});

document.getElementById("btnTplClose").addEventListener("click", closeTplModal);
document.getElementById("btnTplAdd").addEventListener("click", () => openTplEditModal(null));
document.getElementById("btnTplDeleteSelected").addEventListener("click", deleteSelectedTpl);

document.getElementById("btnTplSave").addEventListener("click", saveTplEdit);
document.getElementById("btnTplCancel").addEventListener("click", closeTplEditModal);

monthEl.addEventListener("change", loadState);
yearEl.addEventListener("input", loadState);
objectSelect.addEventListener("change", loadState);

window.addEventListener("beforeunload", saveState);

/* ================= INIT ================= */
loadObjects();
loadState();
</script>
</body>
</html>
