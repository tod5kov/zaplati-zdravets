<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –í–µ–¥–æ–º–æ—Å—Ç –∏ —Ñ–∏—à–æ–≤–µ</title>

<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
h2,h3 { margin:8px 0; }
.toolbar { margin:10px 0 15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

button, select {
  padding:6px 10px; border:1px solid #333; background:#fff;
  border-radius:6px; cursor:pointer;
}
button:hover { background:#eee; }

table { border-collapse: collapse; width:100%; background:#fff; margin-top:6px; }
th,td { border:1px solid #000; padding:5px; font-size:12px; text-align:center; }
th { background:#e8eef5; }
input { width:95px; }

.archive {
  background:#fff; border:1px solid #999; padding:8px; border-radius:6px;
}
.archive ul { margin:6px 0 0; padding-left:18px; }
.archive li { cursor:pointer; margin:4px 0; }
.archive li:hover { text-decoration:underline; }

.fish { border:1px solid #000; padding:10px; margin:10px 0; page-break-inside:avoid; }
.cut { border-top:2px dashed #000; margin:12px 0; }

@media print {
  .toolbar, .archive, .no-print { display:none !important; }
  body { background:#fff; padding:0; }
}
</style>
</head>

<body>

<h2>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –ï–∫–æ –∫–æ–º–ø–ª–µ–∫—Å ‚Äû–ó–¥—Ä–∞–≤–µ—Ü‚Äú</h2>

<div class="toolbar">
  <label>–ú–µ—Å–µ—Ü:
    <select id="month">
      <option>–Ø–Ω—É–∞—Ä–∏</option><option>–§–µ–≤—Ä—É–∞—Ä–∏</option><option>–ú–∞—Ä—Ç</option>
      <option>–ê–ø—Ä–∏–ª</option><option>–ú–∞–π</option><option>–Æ–Ω–∏</option>
      <option>–Æ–ª–∏</option><option>–ê–≤–≥—É—Å—Ç</option><option>–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
      <option>–û–∫—Ç–æ–º–≤—Ä–∏</option><option>–ù–æ–µ–º–≤—Ä–∏</option><option>–î–µ–∫–µ–º–≤—Ä–∏</option>
    </select>
  </label>

  <label>–ì–æ–¥–∏–Ω–∞:
    <input type="number" id="year" value="2025" style="width:80px;">
  </label>

  <button onclick="addRow()">‚ûï –°–ª—É–∂–∏—Ç–µ–ª</button>
  <button onclick="generateAll()">üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button>
  <button onclick="exportPDF()">üìÑ PDF</button>
  <button onclick="exportExcel()">üìä Excel</button>
</div>

<div class="archive">
  <b>–ê—Ä—Ö–∏–≤ –ø–æ –º–µ—Å–µ—Ü–∏</b>
  <ul id="archiveList"></ul>
</div>

<table class="no-print">
<thead>
<tr>
<th>–ò–º–µ</th><th>–û—Å–Ω–æ–≤–Ω–∞</th><th>–ß–∞—Å/–º–µ—Å</th><th>–û—Ç—Ä–∞–±.</th>
<th>–°—Ç–∞–≤–∫–∞</th><th>–ó–∞–ø–ª–∞—Ç–∞</th>
<th>–î–Ω–∏</th><th>–ü—ä—Ç–Ω–∏/–¥–µ–Ω</th><th>–ü—ä—Ç–Ω–∏</th>
<th>–î–æ–±–∞–≤–∫–∏</th><th>–û–±—â–æ</th>
<th>–ê–≤–∞–Ω—Å</th><th>–£–¥—Ä—ä–∂–∫–∏</th><th>–û—Å—Ç–∞—Ç—ä–∫</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="fishes"></div>
<div id="summary"></div>

<script>
/* ================= SETUP ================= */
const tbody = document.getElementById("tbody");
const monthEl = document.getElementById("month");
const yearEl  = document.getElementById("year");
const archiveList = document.getElementById("archiveList");

const n = v => Number(v) || 0;
const f = v => n(v).toFixed(2);

function storageKey(m = monthEl.value, y = yearEl.value) {
  return `zaplati_${y}_${m}`;
}

/* ================= ROW ================= */
function addRow(prefill = {}) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
<td><input class="name" value="${prefill.name||""}"></td>
<td><input class="osn" type="number" value="${prefill.osn||""}"></td>
<td><input class="chm" type="number" value="${prefill.chm||""}"></td>
<td><input class="otr" type="number" value="${prefill.otr||""}"></td>
<td class="stavka">0.00</td>
<td class="zap">0.00</td>
<td><input class="dni" type="number" value="${prefill.dni||""}"></td>
<td><input class="pden" type="number" value="${prefill.pden||""}"></td>
<td class="patni">0.00</td>
<td><input class="dob" type="number" value="${prefill.dob||0}"></td>
<td class="obshto">0.00</td>
<td><input class="av" type="number" value="${prefill.av||0}"></td>
<td><input class="ud" type="number" value="${prefill.ud||0}"></td>
<td class="ostatak">0.00</td>`;

  tr.querySelectorAll("input").forEach(i =>
    i.addEventListener("input", () => {
      calc(tr);
      saveState();
      renderArchive();
    })
  );

  tbody.appendChild(tr);
  calc(tr);
  saveState();
  renderArchive();
}

/* ================= CALC ================= */
function calc(tr) {
  const osn=n(tr.querySelector(".osn").value);
  const chm=n(tr.querySelector(".chm").value);
  const otr=n(tr.querySelector(".otr").value);
  const dni=n(tr.querySelector(".dni").value);
  const pden=n(tr.querySelector(".pden").value);
  const dob=n(tr.querySelector(".dob").value);
  const av=n(tr.querySelector(".av").value);
  const ud=n(tr.querySelector(".ud").value);

  const stavka = chm ? osn/chm : 0;
  const zap = stavka * otr;
  const patni = dni * pden;
  const obshto = zap + patni + dob;
  const ostatak = obshto - av - ud;

  tr.querySelector(".stavka").textContent=f(stavka);
  tr.querySelector(".zap").textContent=f(zap);
  tr.querySelector(".patni").textContent=f(patni);
  tr.querySelector(".obshto").textContent=f(obshto);
  tr.querySelector(".ostatak").textContent=f(ostatak);
}

/* ================= SAVE / LOAD ================= */
function saveState() {
  const rows = [];
  tbody.querySelectorAll("tr").forEach(tr => {
    rows.push({
      name: tr.querySelector(".name").value,
      osn: tr.querySelector(".osn").value,
      chm: tr.querySelector(".chm").value,
      otr: tr.querySelector(".otr").value,
      dni: tr.querySelector(".dni").value,
      pden: tr.querySelector(".pden").value,
      dob: tr.querySelector(".dob").value,
      av: tr.querySelector(".av").value,
      ud: tr.querySelector(".ud").value
    });
  });
  localStorage.setItem(storageKey(), JSON.stringify(rows));
}

function loadState(m = monthEl.value, y = yearEl.value) {
  tbody.innerHTML = "";
  const raw = localStorage.getItem(storageKey(m,y));
  if (raw) JSON.parse(raw).forEach(e => addRow(e));
  if (tbody.children.length === 0) addRow();
}

/* ================= ARCHIVE ================= */
function renderArchive() {
  archiveList.innerHTML = "";
  Object.keys(localStorage)
    .filter(k => k.startsWith("zaplati_"))
    .sort()
    .forEach(k => {
      const [,year,month] = k.split("_");
      const li = document.createElement("li");
      li.textContent = `${month} ${year}`;
      li.onclick = () => {
        monthEl.value = month;
        yearEl.value = year;
        loadState(month,year);
      };
      archiveList.appendChild(li);
    });
}

/* ================= OUTPUT ================= */
function generateAll() {
  generateFishes();
  generateSummary();
}

function generateFishes() {
  const box = document.getElementById("fishes");
  box.innerHTML = `<h3>–§–∏—à–æ–≤–µ ‚Äì ${monthEl.value} ${yearEl.value}</h3>`;
  tbody.querySelectorAll("tr").forEach(tr => {
    const name = tr.querySelector(".name").value;
    if (!name) return;
    box.innerHTML += `
<div class="fish">
<b>${name}</b><br>
–ü–µ—Ä–∏–æ–¥: ${monthEl.value} ${yearEl.value}<br>
–ó–∞ –ø–æ–ª—É—á–∞–≤–∞–Ω–µ: <b>${tr.querySelector(".ostatak").textContent} –ª–≤.</b>
</div>
<div class="cut"></div>`;
  });
}

function generateSummary() {
  let total = 0;
  tbody.querySelectorAll(".ostatak").forEach(c => total += n(c.textContent));
  document.getElementById("summary").innerHTML =
    `<h3>–û–±—â–æ –∑–∞ –∏–∑–ø–ª–∞—â–∞–Ω–µ: ${f(total)} –ª–≤.</h3>`;
}

/* ================= EXPORT ================= */
function exportPDF() {
  generateAll();
  window.print();
}

function exportExcel() {
  let csv = "–ò–º–µ;–û—Å–Ω–æ–≤–Ω–∞;–ü—ä—Ç–Ω–∏;–î–æ–±–∞–≤–∫–∏;–ê–≤–∞–Ω—Å;–£–¥—Ä—ä–∂–∫–∏;–ù–µ—Ç–Ω–æ\n";
  tbody.querySelectorAll("tr").forEach(tr => {
    const name = tr.querySelector(".name").value;
    if (!name) return;
    csv += [
      name,
      tr.querySelector(".osn").value,
      tr.querySelector(".patni").textContent,
      tr.querySelector(".dob").value,
      tr.querySelector(".av").value,
      tr.querySelector(".ud").value,
      tr.querySelector(".ostatak").textContent
    ].join(";") + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `zaplati_${monthEl.value}_${yearEl.value}.csv`;
  a.click();
}

/* ================= INIT ================= */
monthEl.addEventListener("change", () => loadState());
yearEl.addEventListener("input", () => loadState());
loadState();
renderArchive();
</script>

</body>
</html>
