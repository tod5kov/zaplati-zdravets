<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>2–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –í–µ–¥–æ–º–æ—Å—Ç –∏ —Ñ–∏—à–æ–≤–µ</title>

<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
h2,h3 { margin:6px 0; }
.toolbar { margin:10px 0 15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
button { padding:6px 12px; border:1px solid #333; background:#fff; border-radius:6px; cursor:pointer; }
button:hover { background:#eee; }

table { border-collapse: collapse; width:100%; background:#fff; }
th,td { border:1px solid #000; padding:5px; font-size:12px; text-align:center; }
th { background:#e8eef5; }
input { width:95px; }
.num { font-variant-numeric: tabular-nums; }

.section { margin-top:25px; }

/* –§–∏—à–æ–≤–µ */
.fish { border:1px solid #000; padding:10px; margin-bottom:12px; page-break-inside:avoid; }
.cut { border-top:2px dashed #000; margin:12px 0; }

/* –ü–µ—á–∞—Ç */
@media print {
  .toolbar, .no-print { display:none !important; }
  body { background:#fff; padding:0; }
  .page-break { page-break-after: always; }
}
</style>
</head>

<body>

<h2>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –ï–∫–æ –∫–æ–º–ø–ª–µ–∫—Å ‚Äû–ó–¥—Ä–∞–≤–µ—Ü‚Äú</h2>

<div class="toolbar">
  <label>–ú–µ—Å–µ—Ü:
    <select id="month">
      <option>–Ø–Ω—É–∞—Ä–∏</option><option>–§–µ–≤—Ä—É–∞—Ä–∏</option><option>–ú–∞—Ä—Ç</option>
      <option>–ê–ø—Ä–∏–ª</option><option>–ú–∞–π</option><option>–Æ–Ω–∏</option>
      <option>–Æ–ª–∏</option><option>–ê–≤–≥—É—Å—Ç</option><option>–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
      <option>–û–∫—Ç–æ–º–≤—Ä–∏</option><option>–ù–æ–µ–º–≤—Ä–∏</option><option>–î–µ–∫–µ–º–≤—Ä–∏</option>
    </select>
  </label>

  <label>–ì–æ–¥–∏–Ω–∞:
    <input type="number" id="year" value="2025" style="width:80px;">
  </label>

  <button onclick="addRow()">‚ûï –°–ª—É–∂–∏—Ç–µ–ª</button>
  <button onclick="generateAll()">üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∏</button>
  <button onclick="window.print()">üñ® –ü–µ—á–∞—Ç</button>
</div>

<!-- ================= –í–™–í–ï–ñ–î–ê–ù–ï ================= -->
<table id="table" class="no-print">
<thead>
<tr>
<th>–ò–º–µ</th><th>–û—Å–Ω–æ–≤–Ω–∞</th><th>–ß–∞—Å/–º–µ—Å</th><th>–û—Ç—Ä–∞–±.</th>
<th>–°—Ç–∞–≤–∫–∞</th><th>–ó–∞–ø–ª–∞—Ç–∞</th>
<th>–î–Ω–∏</th><th>–ü—ä—Ç–Ω–∏/–¥–µ–Ω</th><th>–ü—ä—Ç–Ω–∏</th>
<th>–î–æ–±–∞–≤–∫–∏</th><th>–û–±—â–æ</th>
<th>–ê–≤–∞–Ω—Å</th><th>–£–¥—Ä—ä–∂–∫–∏</th><th>–û—Å—Ç–∞—Ç—ä–∫</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- ================= –§–ò–®–û–í–ï ================= -->
<div id="fishes" class="section"></div>

<div class="page-break"></div>

<!-- ================= –í–ï–î–û–ú–û–°–¢ ================= -->
<div id="summary" class="section"></div>

<script>
  
const tbody=document.querySelector("#table tbody");
const n=v=>Number(v)||0;
const f=v=>n(v).toFixed(2);

function addRow(prefill = {}) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
<td><input class="name" value="${prefill.name || ""}"></td>
<td><input class="osn" type="number" value="${prefill.osn || ""}"></td>
<td><input class="chm" type="number" value="${prefill.chm || ""}"></td>
<td><input class="otr" type="number" value="${prefill.otr || ""}"></td>
<td class="stavka">0.00</td>
<td class="zap">0.00</td>
<td><input class="dni" type="number" value="${prefill.dni || ""}"></td>
<td><input class="pden" type="number" value="${prefill.pden || ""}"></td>
<td class="patni">0.00</td>
<td><input class="dob" type="number" value="${prefill.dob || 0}"></td>
<td class="obshto">0.00</td>
<td><input class="av" type="number" value="${prefill.av || 0}"></td>
<td><input class="ud" type="number" value="${prefill.ud || 0}"></td>
<td class="ostatak">0.00</td>`;

  tr.querySelectorAll("input").forEach(i =>
    i.oninput = () => {
      calc(tr);
      total();
      saveState(); 
      document.getElementById("month")?.addEventListener("change", saveState);
      document.getElementById("year")?.addEventListener("input", saveState);
// ‚¨Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ
    }
  );
saveState();
  tbody.appendChild(tr);
}


function calc(tr){
  const osn=n(tr.querySelector(".osn").value);
  const chm=n(tr.querySelector(".chm").value);
  const otr=n(tr.querySelector(".otr").value);
  const dni=n(tr.querySelector(".dni").value);
  const pden=n(tr.querySelector(".pden").value);
  const dob=n(tr.querySelector(".dob").value);
  const av=n(tr.querySelector(".av").value);
  const ud=n(tr.querySelector(".ud").value);

  const stavka=chm?osn/chm:0;
  const zap=stavka*otr;
  const patni=dni*pden;
  const obshto=zap+patni+dob;
  const ostatak=obshto-av-ud;

  tr.querySelector(".stavka").textContent=f(stavka);
  tr.querySelector(".zap").textContent=f(zap);
  tr.querySelector(".patni").textContent=f(patni);
  tr.querySelector(".obshto").textContent=f(obshto);
  tr.querySelector(".ostatak").textContent=f(ostatak);
}

function generateAll(){
  document.querySelectorAll("tbody tr").forEach(calc);
  generateFishes();
  generateSummary();
}

/* ===== –§–ò–®–û–í–ï ===== */
function generateFishes(){
  const box=document.getElementById("fishes");
  const m=document.getElementById("month").value;
  const y=document.getElementById("year").value;
  box.innerHTML=`<h3>–§–∏—à–æ–≤–µ ‚Äì ${m} ${y}</h3>`;

  document.querySelectorAll("tbody tr").forEach((tr,i)=>{
    const name=tr.querySelector(".name").value;
    if(!name)return;

    box.innerHTML+=`
<div class="fish">
<b>–°–ª—É–∂–∏—Ç–µ–ª:</b> ${name}<br>
<b>–ü–µ—Ä–∏–æ–¥:</b> ${m} ${y}<br>
<b>–û—Å–Ω–æ–≤–Ω–∞ –∑–∞–ø–ª–∞—Ç–∞:</b> ${tr.querySelector(".osn").value} –ª–≤.<br>
<b>–ü—ä—Ç–Ω–∏:</b> ${tr.querySelector(".patni").textContent} –ª–≤.<br>
<b>–î–æ–±–∞–≤–∫–∏:</b> ${tr.querySelector(".dob").value} –ª–≤.<br>
<b>–ê–≤–∞–Ω—Å:</b> ${tr.querySelector(".av").value} –ª–≤.<br>
<b>–£–¥—Ä—ä–∂–∫–∏:</b> ${tr.querySelector(".ud").value} –ª–≤.<br>
<hr>
<b>–ó–ê –ü–û–õ–£–ß–ê–í–ê–ù–ï:</b> ${tr.querySelector(".ostatak").textContent} –ª–≤.
</div>
<div class="cut"></div>`;
    if((i+1)%3===0) box.innerHTML+=`<div class="page-break"></div>`;
  });
}

/* ===== –û–ë–û–ë–©–ï–ù–ê –í–ï–î–û–ú–û–°–¢ ===== */
function generateSummary(){
  const m=document.getElementById("month").value;
  const y=document.getElementById("year").value;

  let tOsn=0,tPat=0,tDob=0,tAv=0,tUd=0,tNet=0;

  let rows="";
  document.querySelectorAll("tbody tr").forEach(tr=>{
    const name=tr.querySelector(".name").value;
    if(!name)return;

    const osn=n(tr.querySelector(".osn").value);
    const pat=n(tr.querySelector(".patni").textContent);
    const dob=n(tr.querySelector(".dob").value);
    const av=n(tr.querySelector(".av").value);
    const ud=n(tr.querySelector(".ud").value);
    const net=n(tr.querySelector(".ostatak").textContent);

    tOsn+=osn; tPat+=pat; tDob+=dob; tAv+=av; tUd+=ud; tNet+=net;

    rows+=`
<tr>
<td>${name}</td>
<td>${f(osn)}</td>
<td>${f(pat)}</td>
<td>${f(dob)}</td>
<td>${f(av)}</td>
<td>${f(ud)}</td>
<td>${f(net)}</td>
</tr>`;
  });

  document.getElementById("summary").innerHTML=`
<h3>–û–±–æ–±—â–µ–Ω–∞ –≤–µ–¥–æ–º–æ—Å—Ç ‚Äì ${m} ${y}</h3>
<table>
<tr>
<th>–°–ª—É–∂–∏—Ç–µ–ª</th>
<th>–û—Å–Ω–æ–≤–Ω–∞</th>
<th>–ü—ä—Ç–Ω–∏</th>
<th>–î–æ–±–∞–≤–∫–∏</th>
<th>–ê–≤–∞–Ω—Å</th>
<th>–£–¥—Ä—ä–∂–∫–∏</th>
<th>–ù–µ—Ç–Ω–æ</th>
</tr>
${rows}
<tr style="font-weight:bold;background:#eee;">
<td>–û–ë–©–û</td>
<td>${f(tOsn)}</td>
<td>${f(tPat)}</td>
<td>${f(tDob)}</td>
<td>${f(tAv)}</td>
<td>${f(tUd)}</td>
<td>${f(tNet)}</td>
</tr>
</table>

<p style="margin-top:40px;">
–°—ä—Å—Ç–∞–≤–∏–ª: ________________ &nbsp;&nbsp;
–ü—Ä–æ–≤–µ—Ä–∏–ª: ________________
</p>`;
}

const STORAGE_KEY = "zaplati_zdravets_v1";

function saveState() {
  const data = {
    month: document.getElementById("month")?.value,
    year: document.getElementById("year")?.value,
    employees: []
  };

  document.querySelectorAll("tbody tr").forEach(tr => {
    data.employees.push({
      name: tr.querySelector(".name")?.value || "",
      osn: tr.querySelector(".osn")?.value || "",
      chm: tr.querySelector(".chm")?.value || "",
      otr: tr.querySelector(".otr")?.value || "",
      dni: tr.querySelector(".dni")?.value || "",
      pden: tr.querySelector(".pden")?.value || "",
      dob: tr.querySelector(".dob")?.value || "",
      av:  tr.querySelector(".av")?.value || "",
      ud:  tr.querySelector(".ud")?.value || ""
    });
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;

  const data = JSON.parse(raw);

  if (data.month && document.getElementById("month")) {
    document.getElementById("month").value = data.month;
  }
  if (data.year && document.getElementById("year")) {
    document.getElementById("year").value = data.year;
  }

  tbody.innerHTML = "";

  data.employees.forEach(emp => {
    addRow(emp);
  });

  // –ø—Ä–µ–∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ —Å–ª–µ–¥ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
  document.querySelectorAll("tbody tr").forEach(calc);
  total();
}


loadState();
if (tbody.children.length === 0) {
  addRow();
}

window.addEventListener("beforeunload", () => {
  saveState();
});

</script>

</body>
</html>
