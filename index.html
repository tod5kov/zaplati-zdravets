<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –í–µ–¥–æ–º–æ—Å—Ç –∏ —Ñ–∏—à–æ–≤–µ</title>

<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
h2,h3 { margin:8px 0; }
.toolbar { margin:10px 0 15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
button, select { padding:6px 10px; border:1px solid #333; background:#fff; border-radius:6px; cursor:pointer; }
button:hover { background:#eee; }

table { border-collapse: collapse; width:100%; background:#fff; margin-top:6px; }
th,td { border:1px solid #000; padding:5px; font-size:12px; text-align:center; }
th { background:#e8eef5; }
input { width:95px; }

.archive { background:#fff; border:1px solid #999; padding:8px; border-radius:6px; margin:10px 0; }
.archive ul { margin:6px 0 0; padding-left:18px; }
.archive li { cursor:pointer; margin:4px 0; }
.archive li:hover { text-decoration:underline; }

.notice { font-size:12px; color:#333; margin:8px 0 12px; display:none; }
.notice b { color:#b00020; }

.fish { border:1px solid #000; padding:10px; margin:10px 0; page-break-inside:avoid; background:#fff; }
.cut { border-top:2px dashed #000; margin:12px 0; }

@media print {
  .toolbar, .archive, .no-print, .notice { display:none !important; }
  body { background:#fff; padding:0; }
}
</style>
</head>

<body>

<h2>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì –ï–∫–æ –∫–æ–º–ø–ª–µ–∫—Å ‚Äû–ó–¥—Ä–∞–≤–µ—Ü‚Äú</h2>

<div class="toolbar">
  <label>–ú–µ—Å–µ—Ü:
    <select id="month">
      <option>–Ø–Ω—É–∞—Ä–∏</option><option>–§–µ–≤—Ä—É–∞—Ä–∏</option><option>–ú–∞—Ä—Ç</option>
      <option>–ê–ø—Ä–∏–ª</option><option>–ú–∞–π</option><option>–Æ–Ω–∏</option>
      <option>–Æ–ª–∏</option><option>–ê–≤–≥—É—Å—Ç</option><option>–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
      <option>–û–∫—Ç–æ–º–≤—Ä–∏</option><option>–ù–æ–µ–º–≤—Ä–∏</option><option>–î–µ–∫–µ–º–≤—Ä–∏</option>
    </select>
  </label>

  <label>–ì–æ–¥–∏–Ω–∞:
    <input type="number" id="year" value="2025" style="width:80px;">
  </label>

  <button type="button" onclick="addRow()">‚ûï –°–ª—É–∂–∏—Ç–µ–ª</button>
  <button type="button" onclick="generateAll()">üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button>
  <button type="button" onclick="exportPDF()">üìÑ PDF</button>
  <button type="button" onclick="exportExcel()">üìä Excel</button>
</div>

<div id="storageWarning" class="notice">
  ‚ö†Ô∏è –ê–≤—Ç–æ-–∑–∞–ø–∞–∑–≤–∞–Ω–µ—Ç–æ –µ –∏–∑–∫–ª—é—á–µ–Ω–æ, –∑–∞—â–æ—Ç–æ –±—Ä–∞—É–∑—ä—Ä—ä—Ç –±–ª–æ–∫–∏—Ä–∞ localStorage (–Ω–∞–ø—Ä–∏–º–µ—Ä Safari Private Mode).
  –î–∞–Ω–Ω–∏—Ç–µ –Ω—è–º–∞ –¥–∞ —Å–µ –ø–∞–∑—è—Ç —Å–ª–µ–¥ –∑–∞—Ç–≤–∞—Ä—è–Ω–µ.
</div>

<div class="archive">
  <b>–ê—Ä—Ö–∏–≤ –ø–æ –º–µ—Å–µ—Ü–∏</b>
  <ul id="archiveList"></ul>
</div>

<table class="no-print">
<thead>
<tr>
<th>–ò–º–µ</th><th>–û—Å–Ω–æ–≤–Ω–∞</th><th>–ß–∞—Å/–º–µ—Å</th><th>–û—Ç—Ä–∞–±.</th>
<th>–°—Ç–∞–≤–∫–∞</th><th>–ó–∞–ø–ª–∞—Ç–∞</th>
<th>–î–Ω–∏</th><th>–ü—ä—Ç–Ω–∏/–¥–µ–Ω</th><th>–ü—ä—Ç–Ω–∏</th>
<th>–î–æ–±–∞–≤–∫–∏</th><th>–û–±—â–æ</th>
<th>–ê–≤–∞–Ω—Å</th><th>–£–¥—Ä—ä–∂–∫–∏</th><th>–û—Å—Ç–∞—Ç—ä–∫</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="fishes"></div>
<div id="summary"></div>

<script>
/* ================= SETUP ================= */
const tbody = document.getElementById("tbody");
const monthEl = document.getElementById("month");
const yearEl  = document.getElementById("year");
const archiveList = document.getElementById("archiveList");
const warnEl = document.getElementById("storageWarning");

const MONTHS = ["–Ø–Ω—É–∞—Ä–∏","–§–µ–≤—Ä—É–∞—Ä–∏","–ú–∞—Ä—Ç","–ê–ø—Ä–∏–ª","–ú–∞–π","–Æ–Ω–∏","–Æ–ª–∏","–ê–≤–≥—É—Å—Ç","–°–µ–ø—Ç–µ–º–≤—Ä–∏","–û–∫—Ç–æ–º–≤—Ä–∏","–ù–æ–µ–º–≤—Ä–∏","–î–µ–∫–µ–º–≤—Ä–∏"];
const monthIndex = (m) => Math.max(0, MONTHS.indexOf(m));

const n = v => Number(v) || 0;
const f = v => n(v).toFixed(2);

function storageKey(m = monthEl.value, y = yearEl.value) {
  return `zaplati_${y}_${m}`;
}

/* ================= SAFE STORAGE ================= */
let STORAGE_OK = true;
function storageSet(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (e) {
    STORAGE_OK = false;
    warnEl.style.display = "block";
    return false;
  }
}
function storageGet(key) {
  try {
    return localStorage.getItem(key);
  } catch (e) {
    STORAGE_OK = false;
    warnEl.style.display = "block";
    return null;
  }
}
function storageKeys() {
  try {
    return Object.keys(localStorage);
  } catch (e) {
    STORAGE_OK = false;
    warnEl.style.display = "block";
    return [];
  }
}

/* ================= CALC ================= */
function calc(tr) {
  const osn=n(tr.querySelector(".osn").value);
  const chm=n(tr.querySelector(".chm").value);
  const otr=n(tr.querySelector(".otr").value);
  const dni=n(tr.querySelector(".dni").value);
  const pden=n(tr.querySelector(".pden").value);
  const dob=n(tr.querySelector(".dob").value);
  const av=n(tr.querySelector(".av").value);
  const ud=n(tr.querySelector(".ud").value);

  const stavka = chm ? osn/chm : 0;
  const zap = stavka * otr;
  const patni = dni * pden;
  const obshto = zap + patni + dob;
  const ostatak = obshto - av - ud;

  tr.querySelector(".stavka").textContent=f(stavka);
  tr.querySelector(".zap").textContent=f(zap);
  tr.querySelector(".patni").textContent=f(patni);
  tr.querySelector(".obshto").textContent=f(obshto);
  tr.querySelector(".ostatak").textContent=f(ostatak);
}

/* ================= ROW (two variants) ================= */
function buildRow(prefill = {}) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
<td><input class="name" value="${prefill.name ?? ""}"></td>
<td><input class="osn" type="number" value="${prefill.osn ?? ""}"></td>
<td><input class="chm" type="number" value="${prefill.chm ?? ""}"></td>
<td><input class="otr" type="number" value="${prefill.otr ?? ""}"></td>
<td class="stavka">0.00</td>
<td class="zap">0.00</td>
<td><input class="dni" type="number" value="${prefill.dni ?? ""}"></td>
<td><input class="pden" type="number" value="${prefill.pden ?? ""}"></td>
<td class="patni">0.00</td>
<td><input class="dob" type="number" value="${prefill.dob ?? 0}"></td>
<td class="obshto">0.00</td>
<td><input class="av" type="number" value="${prefill.av ?? 0}"></td>
<td><input class="ud" type="number" value="${prefill.ud ?? 0}"></td>
<td class="ostatak">0.00</td>`;
  return tr;
}

// –ó–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è: –¥–æ–±–∞–≤—è —Ä–µ–¥ + auto-save
function addRow(prefill = {}) {
  const tr = buildRow(prefill);

  tr.querySelectorAll("input").forEach(i => {
    i.addEventListener("input", () => {
      calc(tr);
      saveState();
      renderArchive();
    });
  });

  tbody.appendChild(tr);
  calc(tr);
  saveState();
  renderArchive();
}

// –í—ä—Ç—Ä–µ—à–Ω–æ: –¥–æ–±–∞–≤—è —Ä–µ–¥ –±–µ–∑ save/render (–∑–∞ load)
function addRowSilent(prefill = {}) {
  const tr = buildRow(prefill);

  tr.querySelectorAll("input").forEach(i => {
    i.addEventListener("input", () => {
      calc(tr);
      saveState();
      renderArchive();
    });
  });

  tbody.appendChild(tr);
  calc(tr);
}

/* ================= SAVE / LOAD ================= */
function collectRows() {
  const rows = [];
  tbody.querySelectorAll("tr").forEach(tr => {
    rows.push({
      name: tr.querySelector(".name").value,
      osn:  tr.querySelector(".osn").value,
      chm:  tr.querySelector(".chm").value,
      otr:  tr.querySelector(".otr").value,
      dni:  tr.querySelector(".dni").value,
      pden: tr.querySelector(".pden").value,
      dob:  tr.querySelector(".dob").value,
      av:   tr.querySelector(".av").value,
      ud:   tr.querySelector(".ud").value
    });
  });

  // –ø–∞–∑–∏–º —Å–∞–º–æ —Å–º–∏—Å–ª–µ–Ω–∏ —Ä–µ–¥–æ–≤–µ
  return rows.filter(r =>
    (r.name || "").trim() !== "" ||
    [r.osn,r.chm,r.otr,r.dni,r.pden,r.dob,r.av,r.ud].some(x => String(x||"").trim() !== "")
  );
}

function saveState() {
  const payload = JSON.stringify({
    month: monthEl.value,
    year: yearEl.value,
    employees: collectRows()
  });
  storageSet(storageKey(), payload);
}

function loadState(m = monthEl.value, y = yearEl.value) {
  tbody.innerHTML = "";

  const raw = storageGet(storageKey(m,y));
  if (raw) {
    try {
      const data = JSON.parse(raw);
      (data.employees || []).forEach(emp => addRowSilent(emp));
    } catch (e) { /* ignore */ }
  }

  // –≤–∏–Ω–∞–≥–∏ –ø–æ–Ω–µ –µ–¥–∏–Ω —Ä–µ–¥ –∑–∞ –≤—ä–≤–µ–∂–¥–∞–Ω–µ
  if (tbody.children.length === 0) addRowSilent();

  // –°–ª–µ–¥ –∫–∞—Ç–æ –∑–∞—Ä–µ–¥–∏–º ‚Äì –∑–∞–ø–∏—Å–≤–∞–º–µ —Å–∞–º–æ –∞–∫–æ storage —Ä–∞–±–æ—Ç–∏, –∑–∞ –¥–∞ —Ñ–∏–∫—Å–∏—Ä–∞–º–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ç–∞
  if (STORAGE_OK) saveState();
}

/* ================= ARCHIVE ================= */
function renderArchive() {
  archiveList.innerHTML = "";

  const keys = storageKeys()
    .filter(k => k.startsWith("zaplati_"));

  // —Å–æ—Ä—Ç–∏—Ä–∞–Ω–µ: –≥–æ–¥–∏–Ω–∞ desc, –º–µ—Å–µ—Ü desc
  keys.sort((a,b) => {
    const [,ya,ma] = a.split("_");
    const [,yb,mb] = b.split("_");
    const da = Number(ya)*100 + monthIndex(ma);
    const db = Number(yb)*100 + monthIndex(mb);
    return db - da;
  });

  keys.forEach(k => {
    const parts = k.split("_");
    if (parts.length < 3) return;
    const year = parts[1];
    const month = parts.slice(2).join("_"); // –∞–∫–æ –Ω—è–∫–æ–≥–∞ –∏–º–∞ _ –≤ —Ç–µ–∫—Å—Ç–∞

    const li = document.createElement("li");
    li.textContent = `${month} ${year}`;
    li.addEventListener("click", () => {
      monthEl.value = month;
      yearEl.value = year;
      loadState(month, year);
      // —á–∏—Å—Ç–æ UX: –ø–æ–∫–∞–∑–≤–∞–º–µ –∫–∞–∫–≤–æ –µ –∑–∞—Ä–µ–¥–µ–Ω–æ
      document.getElementById("fishes").innerHTML = "";
      document.getElementById("summary").innerHTML = "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
    archiveList.appendChild(li);
  });

  if (keys.length === 0) {
    const li = document.createElement("li");
    li.textContent = "–ù—è–º–∞ –∑–∞–ø–∏—Å–∞–Ω–∏ –º–µ—Å–µ—Ü–∏.";
    li.style.cursor = "default";
    li.style.textDecoration = "none";
    archiveList.appendChild(li);
  }
}

/* ================= OUTPUT ================= */
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

function generateAll() {
  // –≤–∏–Ω–∞–≥–∏ –ø—Ä–µ–∏–∑—á–∏—Å–ª—è–≤–∞–º–µ
  tbody.querySelectorAll("tr").forEach(calc);

  generateFishes();
  generateSummary();

  document.getElementById("fishes").scrollIntoView({ behavior: "smooth" });
}

function generateFishes() {
  const box = document.getElementById("fishes");
  box.innerHTML = `<h3>–§–∏—à–æ–≤–µ ‚Äì ${monthEl.value} ${yearEl.value}</h3>`;

  let count = 0;
  tbody.querySelectorAll("tr").forEach(tr => {
    const name = tr.querySelector(".name").value.trim();
    if (!name) return;
    count++;

    box.innerHTML += `
<div class="fish">
<b>–°–ª—É–∂–∏—Ç–µ–ª:</b> ${escapeHtml(name)}<br>
<b>–ü–µ—Ä–∏–æ–¥:</b> ${monthEl.value} ${yearEl.value}<br>
<b>–û—Å–Ω–æ–≤–Ω–∞:</b> ${f(tr.querySelector(".osn").value)} –ª–≤.<br>
<b>–ü—ä—Ç–Ω–∏:</b> ${tr.querySelector(".patni").textContent} –ª–≤.<br>
<b>–î–æ–±–∞–≤–∫–∏:</b> ${f(tr.querySelector(".dob").value)} –ª–≤.<br>
<b>–ê–≤–∞–Ω—Å:</b> ${f(tr.querySelector(".av").value)} –ª–≤.<br>
<b>–£–¥—Ä—ä–∂–∫–∏:</b> ${f(tr.querySelector(".ud").value)} –ª–≤.<br>
<hr>
<b>–ó–ê –ü–û–õ–£–ß–ê–í–ê–ù–ï:</b> ${tr.querySelector(".ostatak").textContent} –ª–≤.
</div>
<div class="cut"></div>`;
  });

  if (count === 0) {
    box.innerHTML += `<p><i>–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ —Å–ª—É–∂–∏—Ç–µ–ª–∏ (–ø–æ–ø—ä–ª–Ω–∏ –∏–º–µ, –ø–æ—Å–ª–µ ‚Äû–ì–µ–Ω–µ—Ä–∏—Ä–∞–π‚Äú).</i></p>`;
  }
}

function generateSummary() {
  let tOsn=0,tPat=0,tDob=0,tAv=0,tUd=0,tNet=0;
  let rowsHtml = "";

  tbody.querySelectorAll("tr").forEach(tr => {
    const name = tr.querySelector(".name").value.trim();
    if (!name) return;

    const osn = n(tr.querySelector(".osn").value);
    const pat = n(tr.querySelector(".patni").textContent);
    const dob = n(tr.querySelector(".dob").value);
    const av  = n(tr.querySelector(".av").value);
    const ud  = n(tr.querySelector(".ud").value);
    const net = n(tr.querySelector(".ostatak").textContent);

    tOsn+=osn; tPat+=pat; tDob+=dob; tAv+=av; tUd+=ud; tNet+=net;

    rowsHtml += `
<tr>
<td style="text-align:left;padding-left:8px;">${escapeHtml(name)}</td>
<td>${f(osn)}</td>
<td>${f(pat)}</td>
<td>${f(dob)}</td>
<td>${f(av)}</td>
<td>${f(ud)}</td>
<td>${f(net)}</td>
</tr>`;
  });

  document.getElementById("summary").innerHTML = `
<h3>–û–±–æ–±—â–µ–Ω–∞ –≤–µ–¥–æ–º–æ—Å—Ç ‚Äì ${monthEl.value} ${yearEl.value}</h3>
<table>
<thead>
<tr>
<th style="text-align:left;padding-left:8px;">–°–ª—É–∂–∏—Ç–µ–ª</th>
<th>–û—Å–Ω–æ–≤–Ω–∞</th><th>–ü—ä—Ç–Ω–∏</th><th>–î–æ–±–∞–≤–∫–∏</th><th>–ê–≤–∞–Ω—Å</th><th>–£–¥—Ä—ä–∂–∫–∏</th><th>–ù–µ—Ç–Ω–æ</th>
</tr>
</thead>
<tbody>
${rowsHtml || `<tr><td colspan="7"><i>–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –æ–±–æ–±—â–∞–≤–∞–Ω–µ.</i></td></tr>`}
<tr style="font-weight:bold;background:#eee;">
<td style="text-align:left;padding-left:8px;">–û–ë–©–û</td>
<td>${f(tOsn)}</td><td>${f(tPat)}</td><td>${f(tDob)}</td>
<td>${f(tAv)}</td><td>${f(tUd)}</td><td>${f(tNet)}</td>
</tr>
</tbody>
</table>`;
}

/* ================= EXPORT ================= */
function exportPDF() {
  // PDF = –ø–µ—á–∞—Ç -> Save as PDF
  generateAll();
  window.print();
}

function exportExcel() {
  // –ì–µ–Ω–µ—Ä–∏—Ä–∞–º–µ —Ç–∞–±–ª–∏—Ü–∞ –∑–∞ Excel –∫–∞—Ç–æ HTML (Excel –æ—Ç–≤–∞—Ä—è .xls –æ—Ç–ª–∏—á–Ω–æ)
  tbody.querySelectorAll("tr").forEach(calc);

  let rows = "";
  tbody.querySelectorAll("tr").forEach(tr => {
    const name = tr.querySelector(".name").value.trim();
    if (!name) return;

    rows += `
<tr>
  <td>${escapeHtml(name)}</td>
  <td>${f(tr.querySelector(".osn").value)}</td>
  <td>${f(tr.querySelector(".patni").textContent)}</td>
  <td>${f(tr.querySelector(".dob").value)}</td>
  <td>${f(tr.querySelector(".av").value)}</td>
  <td>${f(tr.querySelector(".ud").value)}</td>
  <td>${f(tr.querySelector(".ostatak").textContent)}</td>
</tr>`;
  });

  const html = `
<html>
<head><meta charset="UTF-8"></head>
<body>
  <h3>–ó–∞–ø–ª–∞—Ç–∏ ‚Äì ${monthEl.value} ${yearEl.value}</h3>
  <table border="1">
    <tr>
      <th>–°–ª—É–∂–∏—Ç–µ–ª</th><th>–û—Å–Ω–æ–≤–Ω–∞</th><th>–ü—ä—Ç–Ω–∏</th><th>–î–æ–±–∞–≤–∫–∏</th>
      <th>–ê–≤–∞–Ω—Å</th><th>–£–¥—Ä—ä–∂–∫–∏</th><th>–ù–µ—Ç–Ω–æ</th>
    </tr>
    ${rows || `<tr><td colspan="7">–ù—è–º–∞ –¥–∞–Ω–Ω–∏</td></tr>`}
  </table>
</body>
</html>`;

  const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `zaplati_${monthEl.value}_${yearEl.value}.xls`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ================= EVENTS ================= */
monthEl.addEventListener("change", () => { loadState(); renderArchive(); });
yearEl.addEventListener("input",  () => { loadState(); renderArchive(); });
window.addEventListener("beforeunload", () => saveState());

/* ================= INIT ================= */
loadState();
renderArchive();
</script>

</body>
</html>
